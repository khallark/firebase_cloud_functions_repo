import { onRequest } from "firebase-functions/v2/https";
import { db } from "../firebaseAdmin";
import { SHARED_STORE_ID, SHARED_STORE_ID_2 } from "../config";

const AWBS = [
  80007861216, 80008536171, 80008536160, 80008535946, 80008535725, 80008535611, 80008535412,
  80008535342, 80007861964, 80007861883, 80007861603, 80007861485, 80007861301, 80007860472,
  80007860391, 80007860380, 80007858906, 80007855373, 80009118501, 80009118280, 80008536193,
  80008536112, 80008535751, 80008535736, 80008535585, 80008535515, 80008535250, 80008535180,
  80008535073, 80007861990, 80007861780, 80007861393, 80007861264, 80007860682, 80007860402,
  80009944534, 80009944501, 80009944416, 80009943915, 80009943882, 80009118685, 80009118652,
  80009118431, 80009118313, 80008536182, 80008535235, 80007861835, 80007861544, 80007860575,
  80007858965, 80009944265, 80009943834, 80009118641, 80009118243, 80007693765, 80011496714,
  80011496655, 80011496364, 80011496176, 80010724754, 80010724463, 80010724150, 80010724065,
  80009944346, 80009943985, 80009118582, 80012821501, 80012820801, 80011496773, 80011496681,
  80011496456, 80011496401, 80011496316, 80011496165, 80010724776, 80010724205, 80010723811,
  80010723785, 80010723774, 80013745383, 80012821991, 80012821884, 80012821862, 80012821431,
  80012821324, 80012820554, 80012820425, 80012820370, 80012820145, 80012820075, 80012820064,
  80012820031, 80011496563, 80010724791, 80010074432, 80007856305, 80014455614, 80014455275,
  80013745766, 80013745755, 80013745733, 80013745626, 80013745173, 80013745066, 80013744985,
  80012821243, 80012821140, 80012821022, 80012820683, 80012820521, 80012820392, 80010723730,
  80009118265, 80014455780, 80014455754, 80014455533, 80014455511, 80014455426, 80014455345,
  80013745840, 80013745792, 80013745556, 80013745512, 80013745361, 80012820344, 80014455290,
  80014455220, 80014455194, 80014455150, 80014455113, 80014455080, 80013745696, 80013745442,
  80012821630, 80012821055, 80012820484, 80012820285, 80012820252, 80015994601, 80015994586,
  80015994483, 80015994376, 80015230131, 80015230105, 80015230094, 80014455570, 80014455135,
  80015994590, 80015994516, 80015994435, 80015993820, 80015993805, 80015993772, 80015993761,
  80015993750, 80015993746, 80015230610, 80015230562, 80015230352, 80015230315, 80015230223,
  80015230212, 80015230186, 80015230153, 80015230120, 80014455091, 80013745582, 80013745420,
  80012821464, 80016637514, 80016636781, 80016636523, 80016636512, 80015994450, 80015994203,
  80015993956, 80015993890, 80015993783, 80015230536, 80015230396, 80018311030, 80017896884,
  80017896501, 80016637536, 80016636663, 80016636545, 80015994391, 80015230142, 80014455415,
  80018311155, 80018311100, 80018311085, 80018311015, 80018310993, 80017896965, 80017896851,
  80017896722, 80017896486, 80017896405, 80017896092, 80017896081, 80017896066, 80016637595,
  80019177291, 80018310960, 80017896910, 80017896781,
];

export const func = onRequest(
  {
    cors: true,
    timeoutSeconds: 540,
    memory: "512MiB",
  },
  async (req, res) => {
    try {
      const storeIds = [SHARED_STORE_ID, SHARED_STORE_ID_2];

      const results: ({ totalPrice: number; totalOutstanding: number } | null)[] =
        await Promise.all(
          AWBS.map(async (awb) => {
            for (const storeId of storeIds) {
              try {
                const snap = await db
                  .collection(`accounts/${storeId}/orders`)
                  .where("awb", "==", String(awb))
                  .limit(1)
                  .get();

                if (!snap.empty) {
                  const orderData = snap.docs[0].data();
                  return {
                    totalPrice: Number(orderData.raw.total_price),
                    totalOutstanding: Number(orderData.raw.total_outstanding),
                  };
                }
              } catch (err) {
                console.error(`Error querying storeId=${storeId} awb=${awb}:`, err);
              }
            }

            return null;
          }),
        );

      const orderResults: { totalPrice: number; totalOutstanding: number }[] = [];
      const notFoundAwbs: number[] = [];

      AWBS.forEach((awb, i) => {
        if (results[i] !== null) {
          orderResults.push(results[i]!);
        } else {
          notFoundAwbs.push(awb);
        }
      });

      res.status(200).json({ orderResults, notFoundAwbs });
    } catch (error) {
      console.error("Error in func:", error);
      res.status(500).json({ error: "Internal server error" });
    }
  },
);
